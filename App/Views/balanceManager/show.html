{% extends "base.html" %}

{% block title %} Balance {% endblock %}

{% block footer %}
<!-- todo:  walidacja edytowanych danych z poziomu przeglądarki, dodać niemożność rejestracji gdy jest się zalogowanym, wyświetlenie imienia na stronie głownej gdy jesteś zalogowany lub przekierowanie do menu, poprawienie strony z ustawieniami, dodanie metod płatności w wydatkach, wyświetlanie listy w kolejności od najczęściej używanych -->
<script src="/js/animation.js"></script>
<script type="text/javascript"
 src="//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<meta http-equiv="content-type" content="text/html; charset=utf-8"> 
    <!-- <title>Rezultat zapytania</title> -->
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script src="/js/showGraphs.js"></script>
<script src="/js/showBalance.js"></script>
<script src="/js/app.js"></script>
<script type="text/javascript"></script>
<script>
    // var incomesAmountArray = '{{   entry.title|e('js') }}';   
    // var entryTitle = "{{ entry.title|e('js') }}";
    // console.log(entryTitle);
</script>

<script>
   //przekazanie z twiga do JS
    var incomes = JSON.parse('{{ incomes | json_encode | raw }}');
    var expenses = JSON.parse('{{ expenses | json_encode | raw }}');
    var incomesAmountArray = JSON.parse('{{ incomesAmountArray | json_encode | raw }}');
    var incomesCategoryArray = JSON.parse('{{ incomesCategoryArray | json_encode | raw }}');
    var sumOfIncomes = JSON.parse('{{ sumOfIncomes | json_encode | raw }}');
    var incomeCategoryRecords = JSON.parse('{{ incomeCategoryRecords | json_encode | raw }}');
    var expensesAmountArray = JSON.parse('{{ expensesAmountArray | json_encode | raw }}');
    var expensesCategoryArray = JSON.parse('{{ expensesCategoryArray | json_encode | raw }}');
    var sumOfExpenses = JSON.parse('{{ sumOfExpenses | json_encode | raw }}');
    var expenseCategoryRecords = JSON.parse('{{ expenseCategoryRecords | json_encode | raw }}');



    console.log(incomesCategoryArray);

</script> 

<script src="/js/EditAndDeleteIncomeExpense.js"></script>

<script>
    $(document).ready(function(){
            
            $('#addIncomeForm').validate({
                rules: {
                    amount: {
                        required: true,
                        validAmount: true
                    },
                    comment: {
                        validComment: true,
                    },
        
                },
            });

            $('#editExpenseForm').validate({
                rules: {
                    amount: {
                        required: true,
                        validAmount: true
                    },
                    comment: {
                        validComment: true,
                    },
        
                },
            });
        
        });
</script>

{% endblock %}
{% block body %}

<div class="js-incomeCategoryRecords" data-income-category-records="{{ incomeCategoryRecords }}"></div>

<div class="js-balance" data-balance="{{ balance }}"></div>



<div class="container">
    <div class="row">
        <div class="col-md mt-3 d-flex justify-content-center">
            <div class="p-4" id="menu-balance">

                <form method="post" id="show_balance_form" action="\BalanceManager\add" >
                    <div>
                        <header class="h1">Przeglądaj bilans</header>
                    </div>
                    
                    <div class="input-group my-3 ">
                        <div class="input-group-prepend">
                        <label class="input-group-text" for="period">Okres</label>
                        </div>
                        <select class="custom-select" id="period" name="period">
                            <option selected value=1 class="standard">Bieżący miesiąc</option>
                            <option value=2 class="standard">Poprzedni miesiąc</option>
                            <option value=3 class="standard">Bieżący rok</option>
                            <option value=4 id="not-standard">niestandardowy</option>
                        </select>
                    </div>

                    <div id="select-date">
                        <div><span class="bal-pick-date">Wybierz początkową datę</span></div>
                        <div><input id="start-date" class="showBalance" type="date" name="startDate"/></div>
                        <div><span class="bal-pick-date">Wybierz końcową datę</span></div>
                        <script>
                            document.getElementById('start-date').valueAsDate = new Date();
                        </script>
                        <div><input id="end-date" class="showBalance" type="date" name="endDate"/></div>
                        <script>
                            document.getElementById('end-date').valueAsDate = new Date();
                        </script>
                    </div>
                    <div class="d-flex justify-content-center"><input class="mb-3" id="show-bal"
                            type="submit" value="Pokaż"></div>
                </form>
                
            </div>
        </div>

        <div  class="col-md mt-3 d-flex justify-content-center">
            <div class="p-4 " id="balance-show">
                <header class="h1">BILANS</header>
                <hr>
                <div class = "row no-gutters">
                    <div class = "balance-msg col-5">Początek: </div>
                    <div class = "balance-val col-6"  id= "start">{{ startDate }}</div>
                </div>
                <div class = "row no-gutters">
                    <div class = "balance-msg col-5">Koniec: </div>
                    <div class = "balance-val col-6" id= "end">{{ endDate }} </div>
                </div> 
                <div class = "row no-gutters">
                    <div class = "balance-msg col-5"> Stan: </div>
                    <div class = "balance-val col-6" id= "balance"> </div>
                </div>
                <div id= "balanceMSG"> </div>
                

            </div> 
        </div>
    </div>
</div>

<!-- szare tło -->
<div id="outer"></div>

<!-- edycja przychodu menu -->
<div class="d-flex justify-content-center">
    <div id="editIncome" class="pb-3">
        <!-- <div class="text-center mt-3">Edytuj przychód</div> -->
        <form method="post" id="addIncomeForm" class="mt-3" action="/BalanceManager/updateIncome">
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col d-flex justify-content-center"><input class="add-Income-Form-Input" name="amount" id="amount" type="number" placeholder="kwota"step="0.01" required></div>
                                
                    <div class="col d-flex justify-content-center"><input class="add-Income-Form-Input" name="date" id="datePicker" type="date" /></div>
                
                    <script>
                        document.getElementById('datePicker').valueAsDate = new Date();
                    </script>

                    <div class="col d-flex justify-content-center text-start" id="fieldset">
                        <select class="category-select" id="category" name="category">
                            {% for incomeCategory in incomeCategories %}
                            
                            <!-- <legend> Rodzaj przychodu:</legend> -->
                            <option value="{{ incomeCategory.name }}" class="standard">{{ incomeCategory.name }}</option>
                            <!-- <option value="Odsetki bankowe" class="standard">Odsetki bankowe</option>
                            <option value="Sprzedaż na allegro" class="standard">Sprzedaż na allegro</option>
                            <option value="Inne" id="other">Inne</option> -->
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="row justify-content-center">
                    <div class="mt-4 col d-flex justify-content-center" id="comment_label"><label for="comment">Uwagi</label></div>
                    <div class="mt-2 d-flex justify-content-center"><textarea name="comment" id="comment" rows="4" maxlength="100"></textarea></div>
                </div>
                <input name="id" id="income-id"/>
                <div class="row justify-content-center">
                    <div class="mt-3 col d-flex justify-content-center"><input class="btn btn-primary" id="addIncome" type="submit" value="Zapisz"></div>

                    <div class="mt-3 col d-flex justify-content-center" id="cancel">
                        <div class="btn btn-danger" id="exit-btn" value="Anuluj" onClick="closeWindow()">Anuluj</div>
                    </div>

                </div>
            </div>
         </form>
    </div>
</div>

<!-- usunięcie przychodu -->
<div class="d-flex justify-content-center">
    <div id="deleteIncome">
        <div class="container">
            <form method="post" id="addIncomeForm" class="mt-3" action="\BalanceManager\deleteIncome">
                <div class="row justify-content-center"><div class = "h5 text-center">Czy usunąć pozycję?</div></div>
                
                <div class="row justify-content-center">
                    <input name="id" id="del-income-id"/>
                    <div class="mt-3 col d-flex justify-content-center"><input class="btn btn-primary" id="addIncome" type="submit" value="Usuń"></div>
                    <div class="mt-3 col d-flex justify-content-center" id="cancel">
                        <div class="btn btn-danger" id="exit-btn" value="Anuluj" onClick="closeWindow()">Anuluj</div>
                    </div>
                </div>
                
            </form>
        </div>
    </div>
</div>

<!-- Edycja wydatku -->
<div class="d-flex justify-content-center">
    <div id="editExpense" class="pb-3">
        
        <form method="post" id="editExpenseForm" class="mt-3" action="/BalanceManager/updateExpense">
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col d-flex justify-content-center"><input class="add-Income-Form-Input" name="amount" id="Expenseamount" type="number" placeholder="kwota"step="0.01" required></div>
                                
                    <div class="col d-flex justify-content-center"><input class="add-Income-Form-Input" name="date" id="expenseDatePicker" type="date" /></div>
                
                    <script>
                        document.getElementById('expenseDatePicker').valueAsDate = new Date();
                    </script>

                    <div class="col d-flex justify-content-center text-start" id="fieldset">
                        <select class="category-select" id="expenseCategory" name="category">
                            {% for expenseCategory in expenseCategories %}
                            <option value="{{ expenseCategory.name }}" class="standard">{{ expenseCategory.name }}</option>                         
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col d-flex justify-content-center text-start" id="fieldset">
                        <select class="category-select" id="paymentMethod" name="paymentMethod">
                            {% for paymentMethod in paymentMethods %}
                            <option value="{{ paymentMethod.name }}" class="standard">{{ paymentMethod.name }}</option>                         
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="row justify-content-center">
                    <div class="mt-4 col d-flex justify-content-center" id="comment_label"><label for="expenseComment">Uwagi</label></div>
                    <div class="mt-2 d-flex justify-content-center"><textarea name="comment" id="expenseComment" rows="4" maxlength="100"></textarea></div>
                </div>
                <input name="id" id="expense-id"/>
                <div class="row justify-content-center">
                    <div class="mt-3 col d-flex justify-content-center"><input class="btn btn-primary" id="addExpense" type="submit" value="Zapisz"></div>

                    <div class="mt-3 col d-flex justify-content-center" id="cancel">
                        <div class="btn btn-danger" id="exit-btn" value="Anuluj" onClick="closeWindow()">Anuluj</div>
                    </div>

                </div>
            </div>
         </form>
    </div>
</div>

<!-- usunięcie wydatku -->
<div class="d-flex justify-content-center">
    <div id="deleteExpense">
        <div class="container">
            <form method="post" id="addIncomeForm" class="mt-3" action="\BalanceManager\deleteExpense">
                <div class="row justify-content-center"><div class = "h5 text-center">Czy usunąć pozycję?</div></div>
                
                <div class="row justify-content-center">
                    <input name="id" id="del-expense-id"/>
                    <div class="mt-3 col d-flex justify-content-center"><input class="btn btn-primary" id="addIncome" type="submit" value="Usuń"></div>
                    <div class="mt-3 col d-flex justify-content-center" id="cancel">
                        <div class="btn btn-danger" id="exit-btn" value="Anuluj" onClick="closeWindow()">Anuluj</div>
                    </div>
                </div>
                
            </form>
        </div>
    </div>
</div>


<!-- tabela przychody -->
{% if incomes %}
            <div class ="container table-responsive tab pt-3  mt-3">
                <div class="container"> <h3>Przychody</h3> </div>
            <table class="table table-striped table-hover table-sm">
           
            <tr>
                <!-- <th scope="col" id = "t-lp">l.p.</th> -->
                <th scope="col" id = "t-category" ><div class="mx-1">kategoria</div></th>
                <th scope="col" id = "t-coment">komentarz</th>
                <th scope="col" id = "t-amount">ilość</th>
                <th scope="col" id = "t-date">data</th>
                <th scope="col" id = "t-actions"></th>
                <th scope="col" id = "t-actions"></th>
            </tr><tr>

                {% for income in incomes %}
                <h2></h2>
                 <p></p>

                 <!-- <td >1</td> -->
                 <td ><div class="mx-1">{{ income.name }}</div></td>
                 <td >{{ income.income_comment }}</td>
                 <td >{{ income.amount }}</td>
                 <td >{{ income.date_of_income }}</td>
                 <th id = "t-actions"><div class=" edit btn " id="{{ income.id }}" name="edit" value="Edit" onClick="editIncome(this.id)">Edit</div></th>
                 <th id = "t-actions"><div class=" delete btn " id="{{ income.id }}" name="edit" value="Edit" onClick="deleteIncome(this.id)">Del</div></th>
                 
                 </tr><tr>
                {% endfor %}
                </tr></table></div>
 {% endif %}
 
 <!-- tabela wydatki -->
    {% if expenses %}               
        <div class ="container table-responsive tab pt-3 mt-3">
            <div class="container "> <h3>Wydatki</h3> </div>
            <table class="table table-striped table-hover table-sm table-responsive-sm">
            <tr>
                <!-- <th scope="col" id="t-lp">l.p.</th> -->
                <th scope="col" id = "t-category">kategoria</th>
                <th scope="col" id = "t-coment" >komentarz</th>
                <th scope="col" id = "t-amount">ilość</th>
                <th scope="col" id = "t-amount">metoda płatności</th>
                <th scope="col" id = "t-date">data</th>
                <th scope="col" id = "t-actions"></th>
            <th scope="col" id = "t-actions"></th>
            </tr><tr>      
                {% for expense in expenses %}
                <h2></h2>
                    <p></p>

                    <!-- <td >1</td> -->
                    <td >{{ expense.name }}</td>
                    <td >{{ expense.expense_comment }}</td>
                    <td >{{ expense.amount }}</td>
                    <td >{{ expense.payment_method }}</td>
                    <td >{{ expense.date_of_expense }}</td>
                    <th id = "t-actions"><div class=" edit btn " id="{{ expense.id }}" name="edit" value="Edit" onClick="editExpense(this.id)">Edit</div></th>
                    <th id = "t-actions"><div class=" delete btn " id="{{ expense.id }}" name="edit" value="Edit" onClick="deleteExpense(this.id)">Del</div></th>
                    
                    </tr><tr>
                {% endfor %}
                </tr></table>
        </div>  

    {% endif %}                  
    
    <!-- Wykresy -->
    {% if incomeRecords >=1 %}
        <div class = "container my-3 pie-place"><div class = "pt-4"> <div id="piechart-incomes"></div></div></div>
        {% endif %}
    {% if incomeRecords>=1 or expenseRecords>=1 %} 
        <div class = "container my-3 pie-place "><div class = "pt-4"> <div id="piechart-incomes-and-expenses" ></div></div></div>
        {% endif %}
    {% if expenseRecords>=1 %} 
        <div class = "container my-3 pie-place "><div class = "pt-4"> <div id="piechart-expenses"></div></div></div>
    
    {% endif %}

             

{% endblock %}
